<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .btn-delete {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>ðŸ’° Expense Tracker</h1>
            <div>
                <span class="text-muted me-3">Welcome, <strong>{{ username }}</strong></span>
                <a href="/logout" class="btn btn-outline-danger btn-sm">Logout</a>
            </div>
        </div>
        
        <!-- Statistics Card -->
        <div class="row mb-4">
            <div class="col-md-6 mx-auto">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Spent</h5>
                        <h2 id="totalSpent" class="display-4">â‚¹0.00</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Add Expense Form -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Add New Expense</h5>
                    </div>
                    <div class="card-body">
                        <form action="/add_expense" method="POST">
                            <div class="mb-3">
                                <label for="date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="date" name="date" required>
                            </div>
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="Food">Food</option>
                                    <option value="Transportation">Transportation</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Shopping">Shopping</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount (â‚¹)</label>
                                <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Add Expense</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Pie Chart -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Expenses by Category</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Recent Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                        <th>Description</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionList">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Loading transactions...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let expenseChart = null;

        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();

        // Load data on page load
        window.onload = function() {
            loadStats();
            loadTransactions();
        };

        // Load statistics and update chart
        function loadStats() {
            fetch('/get_stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalSpent').textContent = 'â‚¹' + data.total_spent.toFixed(2);
                    updateChart(data.category_totals);
                })
                .catch(error => console.error('Error loading stats:', error));
        }

        // Update pie chart
        function updateChart(categoryTotals) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            const categories = Object.keys(categoryTotals);
            const amounts = Object.values(categoryTotals);
            
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];

            if (expenseChart) {
                expenseChart.destroy();
            }

            if (categories.length === 0) {
                ctx.font = '16px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No expenses yet', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            expenseChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: categories,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors.slice(0, categories.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': â‚¹' + context.parsed.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Load recent transactions
        function loadTransactions() {
            fetch('/get_expenses')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('transactionList');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No transactions yet</td></tr>';
                        return;
                    }

                    data.forEach(expense => {
                        const row = `
                            <tr>
                                <td>${expense.date}</td>
                                <td><span class="badge bg-primary">${expense.category}</span></td>
                                <td>â‚¹${expense.amount.toFixed(2)}</td>
                                <td>${expense.description || '-'}</td>
                                <td>
                                    <button class="btn btn-danger btn-delete" onclick="deleteExpense(${expense.id})">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => console.error('Error loading transactions:', error));
        }

        // Delete expense
        function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                fetch(`/delete_expense/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadStats();
                        loadTransactions();
                    }
                })
                .catch(error => console.error('Error deleting expense:', error));
            }
        }
    </script>
</body>
</html>
